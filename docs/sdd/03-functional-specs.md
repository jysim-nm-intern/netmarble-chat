# 03. 기능 명세 (Functional Specifications)

← [목차로 돌아가기](../sdd-specification.md)

---

> **작성 규칙:** 각 SPEC은 `ID`, `설명`, `전제 조건`, `입력 계약`, `출력 계약`, `인수 조건`으로 구성됩니다.
> 인수 조건(AC)은 테스트 코드의 기준이 됩니다. 테스트 ID와의 매핑은 [08. 테스트 명세](08-test-specs.md)를 참조하세요.

---

## SPEC-USR: 사용자 인증

### SPEC-USR-001: 닉네임 기반 로그인

**설명:** 사용자는 닉네임을 입력하여 서비스에 접속한다. 선택적으로 프로필 이미지를 첨부하거나 프로필 색상을 고를 수 있다. 동일 닉네임은 동일 사용자로 간주한다.

**전제 조건:** 사용자가 로그인 화면에 있다.

**입력 계약:**
```
POST /api/users
Content-Type: multipart/form-data
- nickname     (String, 필수): 2자 이상 50자 이하, 영문·숫자·한글·언더스코어(_)
- profileColor (String, 선택): hex 색상 코드 (기본값: #4f85c8)
- image        (MultipartFile, 선택): JPG/PNG/GIF, 최대 5MB
```

**출력 계약 (성공):**
```json
// HTTP 201 Created
{
  "userId": 1,
  "nickname": "tester",
  "profileColor": "#4f85c8",
  "profileImage": "data:image/png;base64,..."
}
// → localStorage에 chatUser 저장 후 채팅방 목록으로 이동
```

**출력 계약 (실패):**
```
클라이언트 유효성 실패 → 입력 필드 하단에 오류 메시지 표시, 서버 요청 미발송
서버 오류 → HTTP 4xx/5xx, 에러 메시지 화면 표시
```

**인수 조건:**
- **AC-USR-001-1:** 닉네임이 1자이면 "닉네임은 2자 이상이어야 합니다." 메시지가 표시되고 서버 요청이 발생하지 않는다.
- **AC-USR-001-2:** 유효한 닉네임 입력 후 버튼 클릭 시 `POST /api/users`가 호출된다.
- **AC-USR-001-3:** 서버 응답 성공 시 `localStorage.chatUser`에 사용자 정보가 저장된다.
- **AC-USR-001-4:** 로그인 성공 후 채팅방 목록 화면으로 전환된다.
- **AC-USR-001-5:** 이미 접속한 적 있는 닉네임으로 로그인 시 기존 사용자 정보가 반환되며 프로필 색상·이미지가 갱신된다.
- **AC-USR-001-6:** 프로필 이미지를 첨부하면 로그인 후 채팅 목록 헤더와 채팅방 참여자 목록에 해당 이미지가 표시된다.
- **AC-USR-001-7:** 프로필 이미지를 첨부하지 않으면 색상 팔레트에서 선택한 색상 기반 이니셜 아바타가 표시된다.
- **AC-USR-001-8:** 5MB 초과 이미지 선택 시 경고가 표시되고 첨부가 취소된다.
- **AC-USR-001-9:** JPG, PNG, GIF 외 파일 형식 선택 시 경고가 표시되고 첨부가 취소된다.

---

## SPEC-ROOM: 채팅방 관리

### SPEC-ROOM-001: 채팅방 목록 조회

**설명:** 로그인된 사용자는 활성화된 모든 채팅방 목록과 각 방의 미읽음 메시지 수를 확인할 수 있다.

**전제 조건:** 사용자가 로그인 상태이다.

**입력 계약:**
```
GET /api/chat-rooms?userId={userId}
```

**출력 계약:**
```json
[
  {
    "roomId": 1,
    "name": "채팅방 이름",
    "isActive": true,
    "createdAt": "2026-02-23T10:00:00",
    "unreadCount": 3
  }
]
```

**인수 조건:**
- **AC-ROOM-001-1:** 목록에 활성(isActive=true) 채팅방만 표시된다.
- **AC-ROOM-001-2:** 각 채팅방 항목에 unreadCount가 표시된다.
- **AC-ROOM-001-3:** 목록 로딩 실패 시 "재시도" 버튼이 표시된다.
- **AC-ROOM-001-4:** 채팅방 항목 클릭 시 해당 채팅방으로 이동한다.
- **AC-ROOM-001-5:** 채팅방 썸네일 아바타 그룹은 본인을 항상 제외하고, 현재 참여 중인(active=true) 다른 멤버를 입장 시간(joinedAt) 오름차순으로 최대 4명 표시한다. 방을 나간(active=false) 멤버는 포함하지 않는다.
- **AC-ROOM-001-6:** 본인 외 다른 현재 참여 중인 멤버가 없는 채팅방(단독 참여)이면 아바타 그룹은 비어있다.
- **AC-ROOM-001-7:** 아바타 그룹의 레이아웃은 본인 제외 현재 참여 멤버 수에 따라 결정된다: 1명→원형 아바타 1개, 2명→2개 대각선 겹침, 3명→3개 삼각형 배치, 4명 이상→4개 2×2 그리드.
- **AC-ROOM-001-8:** 프로필 이미지가 없는 멤버의 아바타는 프로필 색상 배경에 닉네임 첫 글자(대문자)가 표시된다.

---

### SPEC-ROOM-002: 채팅방 생성

**설명:** 사용자는 새 채팅방을 생성할 수 있다. 채팅방 이미지를 선택적으로 첨부할 수 있다. 생성 즉시 해당 채팅방에 자동 입장한다.

**전제 조건:** 사용자가 로그인 상태이다.

**입력 계약:**
```
POST /api/chat-rooms
Content-Type: multipart/form-data
- name (String, 필수): 2자 이상 100자 이하
- creatorId (Long, 필수): 생성자 사용자 ID
- image (MultipartFile, 선택): JPG, PNG, GIF / 최대 5MB
```

**출력 계약 (성공):**
```json
// HTTP 201 Created
{ "roomId": 1, "name": "새 채팅방", "imageUrl": "data:image/png;base64,...", "isActive": true, "createdAt": "..." }
// → 서버: SYSTEM 메시지 "[nickname]님이 채팅방을 생성했습니다." 자동 생성
// → 프론트: 생성된 채팅방으로 자동 이동
```

**인수 조건:**
- **AC-ROOM-002-1:** 방 이름이 1자이면 서버 요청이 발생하지 않고 오류 메시지가 표시된다.
- **AC-ROOM-002-2:** 생성 성공 후 채팅방 목록이 갱신된다.
- **AC-ROOM-002-3:** 생성 성공 후 해당 채팅방 화면으로 자동 이동한다.
- **AC-ROOM-002-4:** 이미지를 첨부하지 않으면 기본 아바타(멤버 색상 기반)가 표시된다.
- **AC-ROOM-002-5:** 이미지를 첨부하면 채팅방 목록에서 해당 이미지가 썸네일로 표시된다.
- **AC-ROOM-002-6:** 5MB 초과 이미지 선택 시 "이미지 크기가 5MB를 초과합니다." 경고가 표시되고 첨부가 취소된다.
- **AC-ROOM-002-7:** JPG, PNG, GIF 외 파일 형식 선택 시 "JPG, PNG, GIF 형식만 지원합니다." 경고가 표시되고 첨부가 취소된다.

---

### SPEC-ROOM-003: 채팅방 입장

**설명:** 사용자는 채팅방 목록에서 채팅방을 선택하여 입장한다. 입장 시 최근 메시지 이력을 수신하고 WebSocket을 구독한다.

**전제 조건:** 채팅방이 활성 상태이다. 사용자가 로그인 상태이다.

**입력 계약:**
```json
POST /api/chat-rooms/{roomId}/join
{ "userId": 1 }
```

**출력 계약 (성공):**
```json
{
  "participantId": 1,
  "recentMessages": [
    {
      "messageId": 100,
      "userId": 2,
      "nickname": "사용자명",
      "messageType": "TEXT",
      "content": "안녕하세요",
      "attachmentUrl": null,
      "unreadCount": 0,
      "createdAt": "..."
    }
  ]
}
// → 서버: SYSTEM 메시지 "[nickname]님이 참가했습니다." 브로드캐스트
// → 프론트: WebSocket /topic/room/{roomId} 구독 시작
```

**인수 조건:**
- **AC-ROOM-003-1:** 입장 후 채팅창에 "[nickname]님이 참가했습니다." 시스템 메시지가 표시된다.
- **AC-ROOM-003-2:** 입장 후 WebSocket 연결 상태가 "연결됨"으로 표시된다.
- **AC-ROOM-003-3:** 이전 메시지 이력이 채팅창에 렌더링된다.
- **AC-ROOM-003-4:** 재입장(이전에 나간 적 있는 사용자)도 동일하게 처리된다.
- **AC-ROOM-003-5:** 채팅방 상세 화면 헤더 왼쪽에 '채팅방 목록' 텍스트가 있는 뒤로가기 버튼이 표시되며, 클릭 시 채팅방 목록 화면으로 이동한다.
- **AC-ROOM-003-6:** 채팅방 상세 화면 헤더 중앙에 활성 참여자 아바타 그룹(본인 제외, 최대 4명)과 채팅방 이름, 활성 참여자 수가 함께 표시된다. 아바타 수 및 레이아웃은 AC-ROOM-001-7 규칙을 따른다.
- **AC-ROOM-003-7:** 사이드바 참여자 목록에서 '나'가 최상단에 표시되고, 나머지는 닉네임 사전순(숫자→영어→한글)으로 정렬된다.
- **AC-ROOM-003-8:** 헤더 아바타 그룹에서 프로필 이미지가 없는 멤버의 아바타는 프로필 색상 배경에 닉네임 첫 글자(대문자)가 표시된다.
- **AC-ROOM-003-9:** 사용자가 채팅방에 입장하면 입장 시점(joinedAt) 이후에 전송된 메시지만 채팅창에 표시된다. 입장 이전에 다른 사용자가 보낸 메시지는 표시되지 않는다. 이전에 퇴장했다가 재입장하는 경우 재입장 시점 이후 메시지만 표시된다.

---

### SPEC-ROOM-004: 채팅방 퇴장

**설명:** 사용자는 채팅방에서 나갈 수 있다. 퇴장 후 구독이 해제되고 목록 화면으로 이동한다. 이전 채팅 이력은 보존된다.

**전제 조건:** 사용자가 채팅방에 입장 상태이다.

**입력 계약:**
```json
DELETE /api/chat-rooms/{roomId}/leave
{ "userId": 1 }
```

**출력 계약:**
```json
{ "success": true }
// → 서버: SYSTEM 메시지 "[nickname]님이 나갔습니다." 브로드캐스트
// → 서버: participant.left_at 기록 (Soft Delete)
// → 프론트: WebSocket 구독 해제 후 채팅방 목록으로 이동
```

**인수 조건:**
- **AC-ROOM-004-1:** 퇴장 후 다른 참여자에게 "[nickname]님이 나갔습니다." 시스템 메시지가 표시된다.
- **AC-ROOM-004-2:** 퇴장한 사용자는 채팅방 목록 화면으로 이동한다.
- **AC-ROOM-004-3:** 퇴장 후에도 이전 채팅 이력은 DB에 보존된다.
- **AC-ROOM-004-4:** 퇴장 후 WebSocket 구독이 해제된다.
- **AC-ROOM-004-5:** 사이드바의 '채팅방 나가기' 버튼 클릭 시 브라우저 기본 confirm 대화상자 대신 모달 팝업이 표시된다.
- **AC-ROOM-004-6:** 모달의 '취소' 버튼 또는 배경 클릭 시 팝업이 닫히고 채팅방에 머문다.
- **AC-ROOM-004-7:** 모달의 '나가기' 버튼 클릭 시 퇴장이 완료되고 채팅방 목록 화면으로 이동한다.

---

## SPEC-MSG: 메시지 송수신

### SPEC-MSG-001: 텍스트 메시지 전송

**설명:** 채팅방에 입장한 사용자는 텍스트 메시지를 전송할 수 있다. 실시간 전송이므로 반드시 STOMP 발행 경로를 사용한다. REST API 사용 금지.

**전제 조건:** 사용자가 채팅방에 입장 상태이고 WebSocket이 연결되어 있다.

**입력 계약 (STOMP 발행):**
```json
// 경로: /app/chat.message
{
  "roomId": 1,
  "userId": 1,
  "messageType": "TEXT",
  "content": "안녕하세요",
  "attachmentUrl": null
}
// content: 1자 이상, 공백만인 경우 불허
```

**출력 계약 (STOMP 브로드캐스트):**
```json
// 경로: /topic/room/{roomId} → 해당 방 구독자 전체
{
  "messageId": 50,
  "userId": 1,
  "nickname": "발신자닉네임",
  "messageType": "TEXT",
  "content": "안녕하세요",
  "attachmentUrl": null,
  "unreadCount": 2,
  "createdAt": "..."
}
```

**인수 조건:**
- **AC-MSG-001-1:** 메시지 전송 후 채팅창에 즉시 표시된다.
- **AC-MSG-001-2:** 같은 채팅방의 다른 사용자에게도 실시간으로 메시지가 표시된다.
- **AC-MSG-001-3:** 내가 보낸 메시지는 우측 정렬, 상대 메시지는 좌측 정렬로 표시된다.
- **AC-MSG-001-4:** 공백만 입력된 경우 전송되지 않는다.
- **AC-MSG-001-5:** WebSocket 미연결 상태에서는 전송 버튼이 비활성화된다.

**메시지 UI 표시 규칙 (AC-MSG-UI):**
- **AC-MSG-UI-001 시간 그루핑:** 동일 송신자가 같은 '분(minute)' 내에 연속으로 보낸 메시지는 그 '분'에서 마지막으로 보낸 메시지 옆에만 시간이 표시된다. 이전 메시지에는 시간이 표시되지 않는다.
- **AC-MSG-UI-002 시간 형식:** 시간은 `오전/오후 H:MM` 형식으로 표시된다 (예: 오전 9:05, 오후 1:30).
- **AC-MSG-UI-003 시간 위치 - 내 메시지:** 시간은 말풍선 왼쪽 하단 외부에 표시된다.
- **AC-MSG-UI-004 시간 위치 - 타인 메시지:** 시간은 말풍선 오른쪽 하단 외부에 표시된다.
- **AC-MSG-UI-005 unreadCount 위치 - 내 메시지:** unreadCount(> 0)는 시간 표시 바로 위(z축 위)에 말풍선에 가깝게 표시된다.
- **AC-MSG-UI-006 unreadCount 위치 - 타인 메시지:** unreadCount(> 0)는 시간 표시 바로 위(z축 위)에 말풍선에 가깝게 표시된다.
- **AC-MSG-UI-007 unreadCount 표시 조건:** unreadCount가 0이면 표시하지 않는다.

---

### SPEC-MSG-002: 이미지 전송

**설명:** 사용자는 이미지 파일을 채팅방에 전송할 수 있다. 파일을 REST API로 먼저 업로드하고, 반환된 URL로 STOMP 메시지를 발행한다.

**전제 조건:** WebSocket이 연결되어 있다.

**입력 계약 (파일 업로드):**
```
POST /api/messages/attachments
Content-Type: multipart/form-data
파일 조건: JPG, PNG, GIF / 최대 5MB
```

**출력 계약 (파일 업로드):**
```json
{ "fileUrl": "http://localhost:8080/uploads/uuid.jpg", "fileType": "IMAGE" }
```

**입력 계약 (STOMP 발행):**
```json
{
  "roomId": 1, "userId": 1,
  "messageType": "IMAGE",
  "content": "[이미지]",
  "attachmentUrl": "http://localhost:8080/uploads/uuid.jpg"
}
```

**인수 조건:**
- **AC-MSG-002-1:** 5MB 초과 파일 선택 시 "파일 크기가 초과되었습니다." 경고가 표시된다.
- **AC-MSG-002-2:** 지원하지 않는 형식 선택 시 경고 메시지가 표시된다.
- **AC-MSG-002-3:** 업로드 중 로딩 상태가 표시된다.
- **AC-MSG-002-4:** 업로드 완료 후 채팅창에 이미지가 렌더링된다.

---

### SPEC-MSG-003: 스티커 전송

**설명:** 사용자는 사전 정의된 스티커 팩에서 스티커를 선택하여 전송할 수 있다. 별도의 파일 업로드 없이 스티커 ID만 STOMP로 발행한다.

**전제 조건:** WebSocket이 연결되어 있다.

**입력 계약 (STOMP 발행):**
```json
{
  "roomId": 1, "userId": 1,
  "messageType": "STICKER",
  "content": "[스티커]",
  "attachmentUrl": "STK_01"
}
```

**인수 조건:**
- **AC-MSG-003-1:** 스티커 버튼 클릭 시 스티커 선택 모달이 표시된다.
- **AC-MSG-003-2:** 스티커 선택 후 모달이 닫히고 채팅창에 스티커 이미지가 표시된다.
- **AC-MSG-003-3:** 다른 사용자에게도 동일한 스티커가 실시간으로 표시된다.

---

### SPEC-MSG-004: 메시지 이력 조회

**설명:** 채팅방 입장 시 이전 메시지 이력을 커서 기반 페이지네이션으로 조회한다.

**입력 계약:**
```
GET /api/rooms/{roomId}/messages?cursor={messageId}&limit=50
cursor: 마지막으로 로드한 메시지 ID (첫 조회 시 생략)
limit: 기본값 50
```

**출력 계약:**
```json
{
  "messages": [ /* MessageResponse 배열 */ ],
  "nextCursor": 100   // null이면 더 이상 이력 없음
}
```

---

### SPEC-MSG-005: 메시지 검색

**설명:** 현재 입장한 채팅방 내에서 키워드로 메시지를 검색한다. 대소문자 구분 없이 검색된다.

**전제 조건:** 사용자가 채팅방에 입장 상태이다.

**입력 계약:**
```
GET /api/chat-rooms/{roomId}/messages/search?keyword={keyword}
keyword: 1자 이상, 255자 이하, 공백 및 특수문자 허용, 빈 문자열이면 요청 미발송
```

**출력 계약 (성공):**
```json
// 정렬: createdAt 역순 (최신순)
[
  {
    "messageId": 1,
    "userId": 2,
    "nickname": "발신자명",
    "messageType": "TEXT",
    "content": "검색어를 포함한 내용",
    "createdAt": "..."
  }
]
```

**인수 조건:**
- **AC-MSG-005-1:** 검색어가 비어있고 발신자 필터도 선택되지 않은 상태에서 제출하면 "검색어를 입력해주세요." 메시지가 표시되고 API가 호출되지 않는다.
- **AC-MSG-005-1b:** 발신자 필터가 선택된 상태에서 검색어를 비우고 제출하면 오류 메시지 없이 발신자 단독 필터링 모드로 전환되어 해당 발신자의 메시지만 표시된다.
- **AC-MSG-005-2:** 검색 결과가 있으면 최신순으로 정렬된 목록이 표시된다.
- **AC-MSG-005-3:** 검색 결과가 없으면 "검색 결과가 없습니다." 메시지가 표시된다.
- **AC-MSG-005-4:** 검색은 대소문자를 구분하지 않는다.
- **AC-MSG-005-5:** 검색 중 로딩 상태가 표시된다.
- **AC-MSG-005-6:** 서버 오류 시 오류 메시지와 재시도 수단이 표시된다.
- **AC-MSG-005-7:** 화살표로 검색 결과를 이동하거나 결과가 처음 표시될 때, 해당 메시지 버블에 바운스 애니메이션(`message-bounce`)이 적용되어 현재 포커스된 결과임을 시각적으로 표시한다. 노란 테두리 링 방식은 사용하지 않는다.

---

## SPEC-READ: 읽음 처리

### SPEC-READ-001: 메시지 읽음 처리 (워터마크 갱신)

**설명:** 사용자가 채팅방 내 메시지를 읽으면 워터마크를 서버에 전송한다. 이를 통해 미읽음 카운트가 실시간으로 갱신된다.

**전제 조건:** 사용자가 채팅방에 입장 상태이고 WebSocket이 연결되어 있다.

**입력 계약 (STOMP 발행):**
```json
// 경로: /app/chat.read
{
  "roomId": 1,
  "userId": 1,
  "lastReadMessageId": 150
}
```

**출력 계약 (STOMP 브로드캐스트):**
```json
// 경로: /topic/room/{roomId}
{
  "type": "READ_STATUS_UPDATE",
  "roomId": 1,
  "userId": 1,
  "lastReadMessageId": 150
}
// → 수신한 클라이언트는 영향받는 메시지들의 unreadCount를 갱신한다.
```

**인수 조건:**
- **AC-READ-001-1:** 사용자가 채팅방에 입장하면 모든 메시지에 대해 즉시 읽음 처리가 발송된다.
- **AC-READ-001-2:** 다른 사용자가 읽음 처리 시 해당 메시지의 unreadCount가 실시간으로 감소한다.
- **AC-READ-001-3:** 모든 활성 참여자가 읽으면 unreadCount가 0이 되어 표시가 사라진다.
- **AC-READ-001-4:** 참여자가 2명일 때 상대가 읽으면 unreadCount가 0으로 사라진다.
- **AC-READ-001-5:** 참여자가 3명 이상일 때 1명이 읽으면 unreadCount가 1 감소한다.

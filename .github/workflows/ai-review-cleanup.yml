name: AI Review Smart Cleanup

on:
  pull_request:
    # PRì´ ìƒˆë¡œ ì—´ë¦¬ê±°ë‚˜, ì»¤ë°‹ì´ ì¶”ê°€ë˜ê±°ë‚˜, ë‹«í˜”ë‹¤ ë‹¤ì‹œ ì—´ë¦´ ë•Œ ì‹¤í–‰
    types: [opened, synchronize, reopened]

jobs:
  smart-cleanup:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Cleanup Stale AI Comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            /**
             * ë´‡ ê³„ì • íŒë³„: GitHub ë´‡ì€ ë¡œê·¸ì¸ëª…ì´ '[bot]'ìœ¼ë¡œ ëë‚¨
             * ì˜ˆ) copilot[bot], github-actions[bot], coderabbitai[bot]
             */
            function isBot(login) {
              return login.endsWith('[bot]');
            }

            // databaseId: GraphQL ì „ìš© opaque IDê°€ ì•„ë‹Œ REST API ìˆ«ì IDë¥¼ ì§ì ‘ ë°˜í™˜
            // â†’ github.rest.pulls.deleteReviewComment({ comment_id: databaseId }) ì— ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    reviewThreads(first: 100) {
                      nodes {
                        id
                        isResolved
                        comments(first: 50) {
                          nodes {
                            id
                            databaseId
                            author { login }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              prNumber: context.payload.pull_request.number
            });

            const threads = result.repository.pullRequest.reviewThreads.nodes;
            console.log(`ì´ ${threads.length}ê°œì˜ ë¦¬ë·° ìŠ¤ë ˆë“œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.`);

            for (const thread of threads) {
              const comments = thread.comments.nodes;
              if (comments.length === 0) continue;

              // âœ… ë³´ì¡´ ê·œì¹™ 1: Resolved(í•´ê²°ë¨) ìŠ¤ë ˆë“œ â€” ìˆ˜ì • ì™„ë£Œëœ ìœ ì˜ë¯¸í•œ ê¸°ë¡
              if (thread.isResolved) continue;

              // âœ… ë³´ì¡´ ê·œì¹™ 2: ì‚¬ëŒì´ ë‹µê¸€ì„ ë‹¨ ìŠ¤ë ˆë“œ â€” ì§„í–‰ ì¤‘ì¸ í† ë¡ , ë§¥ë½ ìœ ì§€
              const hasHumanReply = comments.some(c => !isBot(c.author.login));
              if (hasHumanReply) continue;

              // ğŸ—‘ï¸ ì‚­ì œ ëŒ€ìƒ: ë´‡ì´ ì‹œì‘í–ˆê³ , ë¯¸í•´ê²°ì´ë©°, ì‚¬ëŒ ê°œì…ì´ ì—†ëŠ” ê³ ë¦½ëœ ìŠ¤ë ˆë“œ
              const firstAuthor = comments[0].author.login;
              if (!isBot(firstAuthor)) continue;

              console.log(`ì‚­ì œ ëŒ€ìƒ ë°œê²¬: ë´‡ ë‹¨ë… ë¯¸í•´ê²° ìŠ¤ë ˆë“œ (ì½”ë©˜íŠ¸ ${comments.length}ê°œ, ì‘ì„±ì: ${firstAuthor})`);

              for (const comment of comments) {
                try {
                  // databaseIdë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ID ë³€í™˜ ì—†ì´ REST API ì§ì ‘ í˜¸ì¶œ ê°€ëŠ¥
                  await github.rest.pulls.deleteReviewComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: comment.databaseId
                  });
                  console.log(`ì‚­ì œ ì™„ë£Œ: ì½”ë©˜íŠ¸ #${comment.databaseId}`);
                } catch (e) {
                  // ì‚­ì œ ê¶Œí•œ ì—†ëŠ” ê²½ìš° (ë´‡ì´ ì•„ë‹Œ ì•± í† í° ë“±) â†’ Minimize(ìˆ¨ê¹€) ì²˜ë¦¬ë¡œ ëŒ€ì²´
                  console.log(`ì‚­ì œ ì‹¤íŒ¨ (${e.message}), Minimize ì²˜ë¦¬ ì‹œë„ ì¤‘...`);
                  try {
                    await github.graphql(`
                      mutation($subjectId: ID!) {
                        minimizeComment(input: { subjectId: $subjectId, classifier: OUTDATED }) {
                          minimizedComment { isMinimized }
                        }
                      }
                    `, { subjectId: comment.id });
                    console.log(`Minimize ì²˜ë¦¬ ì™„ë£Œ: ì½”ë©˜íŠ¸ #${comment.databaseId}`);
                  } catch (me) {
                    console.log(`Minimizeë„ ì‹¤íŒ¨: ${me.message}`);
                  }
                }
              }
            }

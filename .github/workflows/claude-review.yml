name: Claude Code Review

on:
  pull_request:
    types: [labeled, synchronize]

jobs:
  claude_review:
    # 'claude-review' 라벨이 붙었을 때만 실행되도록 필터링
    if: contains(github.event.pull_request.labels.*.name, 'claude-review')
    runs-on: ubuntu-latest

    permissions:
      contents: read        # 소스 코드 읽기 권한
      id-token: write       # OIDC 토큰 발급 권한 (Bad credentials 에러 해결)
      pull-requests: write  # PR 리뷰 댓글 작성 권한

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Action Official
        uses: anthropics/claude-code-action@v0.0.31
        with:
          # GitHub 토큰 명시적 전달
          github_token: ${{ secrets.GITHUB_TOKEN }}

          # Anthropic API 키
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # 직접 리뷰 지시 (label_trigger 제거 → synchronize 시에도 동작)
          direct_prompt: |
            PR의 변경 사항을 분석하고 아래 기준으로 코드 리뷰를 남겨주세요.
            1. DDD 계층 준수: Controller → Service → Domain 방향 의존성, Repository 직접 호출 금지
            2. REST/STOMP 역할 분리: 실시간 메시지는 STOMP(/app), 조회/등록은 REST
            3. Entity 직접 반환 금지: API 응답은 반드시 DTO 사용
            4. 보안: SQL 인젝션, XSS, 파일 업로드 취약점, 민감 정보 노출 여부
            5. 인수 조건(AC) 충족: 관련 SPEC의 AC 항목 구현 여부
            필요하다면 직접 수정 코드를 제안(Suggestion)해도 좋습니다.

          # 리뷰가 한 댓글에 계속 업데이트되게 설정
          use_sticky_comment: true

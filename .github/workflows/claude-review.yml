name: Claude Code Review

on:
  pull_request:
    # 라벨 추가 시에만 실행 (synchronize 제외 → 토큰 절감)
    # paths 필터 제거: labeled 이벤트와 함께 쓰면 트리거가 무시됨
    # 파일 범위 제한은 direct_prompt에서 지시하는 방식으로 대체
    types: [labeled]

jobs:
  claude_review:
    # 'claude-review' 라벨이 추가되었을 때만 실행
    if: github.event.label.name == 'claude-review'
    runs-on: ubuntu-latest

    permissions:
      contents: read        # 소스 코드 읽기 권한
      id-token: write       # OIDC 토큰 발급 권한
      pull-requests: write  # PR 리뷰 댓글 작성 권한

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Action Official
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

          # PR에서 변경된 핵심 소스 파일만 리뷰 (워크플로우·설정 파일 제외)
          direct_prompt: |
            이 PR에서 변경된 파일 중 아래 경로에 해당하는 파일만 리뷰해주세요.
            리뷰 대상: server/src/main/java/, server/src/test/java/, client/src/components/, client/src/api/, client/src/store/, client/src/hooks/
            제외 대상: .github/, *.yml, *.yaml, *.properties, build.gradle, package.json, vite.config.* 등 설정·인프라 파일

            아래 기준으로 리뷰해주세요 (항목별로 간결하게):
            1. DDD 계층 준수: Controller → Service → Domain 방향 의존성, Repository 직접 호출 금지
            2. REST/STOMP 역할 분리: 실시간 메시지는 STOMP(/app), 조회/등록은 REST
            3. Entity 직접 반환 금지: API 응답은 반드시 DTO 사용
            4. 보안: SQL 인젝션, XSS, 파일 업로드 취약점, 민감 정보 노출
            5. 인수 조건(AC) 충족: 관련 SPEC의 AC 항목 구현 여부
            문제가 있으면 수정 코드를 Suggestion으로 제안해주세요.

          use_sticky_comment: true
